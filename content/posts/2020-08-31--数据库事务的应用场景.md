---
title: 数据库事务的理解及其应用场景
date: "2020-08-31T15:00:20.641Z"
template: "post"
draft: false
slug: "数据库事务的应用场景"
category: "Database"
tags:
  - "Database"
  - "Transaction"
description: "解释数据库事务的基本原则-ACID原则，并解释数据库事务的具体隔离级别，包括：能读到未提交的数据、能读到已提交的数据、可重复读和串行执行，已经他们所能产生的影响。"
socialImage: "/media/42-line-bible.jpg"
---

- [事务的应用场景](#事务的应用场景)
- [事务提供的保证 - ACID原则](#事务提供的保证 - ACID原则)
- [事务的隔离级别](#事务的隔离级别)

## 事务的应用场景

交易系统当中同时记录 **流水表** 和 **余额表**，因为在交易系统中单独记录流水可能会因为某些原因，如：网路错误、人为修改、业务变更，导致流水数据可能会在对账系统中对不上号。因此，在实际使用当中需要用到余额表来统计余额，从而到达备份和增加余额计算效率的功能。

而流水表和余额表的同时修改，需要保证数据存入的一致性。数据库提供了事务机制来解决这个问题，实际上事务这个特性最初就是被设计用来解决交易问题的，在英文中，事务和交易就是同一个单词：`Transaction`。

### 事务提供的保证 - ACID原则

1. 原子性（Atomic）: 数据库需要保证表的更新要么是成功的，要么是失败的。
2. 一致性（Consistency）: 保证同时修改的多张表之间记录的一致性。
3. 隔离性（Isolation）: 中间状态一定是存在的，而事务能够保证这种中间状态不能够被其他数据库请求读到。
4. 持久性（Durability）: 一旦事务提交成功，数据的结果一定会被存到磁盘，不会因为宕机而丢失。

`ACID`是一个理想的状态，不能完全满足，所以才有了事务对阿隔离级别。`注：事务的原子性和持久性必须要保证。`

### 事务的隔离级别

![img](https://static001.geekbang.org/resource/image/3c/3e/3c37eff420c7a9e41e6121ff491c8c3e.jpg)

一共有四种隔离级别：`RU`、`RC`、`RR` 和` SERIALIZABLE`. 越来越严格，性能越来越差。`常用RC和RU两种`。mysql默认使用`RR`。

* RU：能够读取未经过`commit`的事务。存在脏读。
* RC：只能读取`commit`的事务。
* RR：判断标准 - 在一次事务执行过程中读取两次，能够读到其他已提交事务的修改。快照。（改）
* SERIALIZABLE：不存在幻读，幻读是指在一次事务执行过程中，先读判断为空，再存，这时候抢先被其他会话存放，导致主键冲突。再查询的时候发现没有存入成功，就像发生了幻觉。（增）

总结脏读，不可重复读和幻读对应到的场景：

* 脏读：多张表，主会话做修改，其他会话`查询`，`查询`结果不一致。
* 不可重复读：同一张表，主会话多次查询，其他会话做`修改`，`查询`结果不一致。
* 幻读：同一张表，主会话做查询插入查询，其他会话做`插入`，`查询`结果不一致。